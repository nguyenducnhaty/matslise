//
// Created by toon on 5/16/18.
//

#ifndef SCHRODINGER_LEGENDRE_H
#define SCHRODINGER_LEGENDRE_H

#include <functional>
#include <iostream>

namespace legendre {
    template<class D = double>
    class array2d {
        int rows, cols;
        D *values;
    public:
        array2d(int rows, int cols, D *values) : rows(rows), cols(cols), values(values) {}

        D *operator[](int row) const {
            return values + cols * row;
        }

        virtual ~array2d() {
            delete[] values;
        }
    };

    struct LegendreData {
        int n;
        array2d<double> polynomial;
        double *nodes;
        double *weights;
    };

    static LegendreData legendreData[] = {
            {
                    0,
                    array2d<double>(0, 0, new double[0]),
                    new double[0],
                    new double[0]
            },
            {
                    2,
                    array2d<double>(2, 2, new double[4]{
                            1.0, 1.0,
                            -0.5773502691896257, 0.5773502691896256
                    }),
                    new double[2]{-0.5773502691896258, 0.5773502691896256},
                    new double[2]{0.9999999999999998, 1.0000000000000004}
            },
            {
                    4,
                    array2d<double>(4, 4, new double[16]{
                            1.0, 1.0, 1.0, 1.0,
                            -0.8611363115940536, -0.3399810435848565, 0.33998104358485626, 0.8611363115940531,
                            0.6123336207187163, -0.32661933500442786, -0.3266193350044281, 0.6123336207187152,
                            -0.30474698495521024, 0.4117279996728997, -0.4117279996728996, 0.3047469849552084
                    }),
                    new double[4]{-0.8611363115940536, -0.33998104358485653, 0.3399810435848563, 0.8611363115940531},
                    new double[4]{0.3478548451374517, 0.6521451548625459, 0.6521451548625463, 0.3478548451374526}
            },
            {
                    6,
                    array2d<double>(6, 6, new double[36]{
                            1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
                            -0.9324695142031534, -0.6612093864662638, -0.23861918608319677, 0.23861918608319688,
                            0.6612093864662635, 0.9324695142031517,
                            0.8042490923773973, 0.15579677912663953, -0.41459132604948906, -0.414591326049489,
                            0.15579677912663886, 0.8042490923773926,
                            -0.6282499246436956, 0.26911576974460033, 0.32396186535393506, -0.3239618653539352,
                            -0.2691157697446009, 0.6282499246436872,
                            0.42200500927063245, -0.4282458620971208, 0.175662340429804, 0.17566234042980383,
                            -0.4282458620971208, 0.42200500927062046,
                            -0.2057123110596345, 0.2943957149254359, -0.3346190207410407, 0.3346190207410408,
                            -0.29439571492543526, 0.20571231105961982
                    }),
                    new double[6]{-0.9324695142031534, -0.6612093864662637, -0.23861918608319677, 0.23861918608319688,
                                  0.6612093864662635, 0.9324695142031517},
                    new double[6]{0.1713244923791671, 0.3607615730481392, 0.46791393457269126, 0.46791393457269126,
                                  0.3607615730481398, 0.1713244923791712}
            },
            {
                    8,
                    array2d<double>(8, 8, new double[64]{
                            1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
                            -0.9602898564975371, -0.7966664774136296, -0.5255324099163281, -0.1834346424956499,
                            0.18343464249564978, 0.5255324099163294, 0.7966664774136274, 0.9602898564975355,
                            0.8832349127380905, 0.4520162143519618, -0.08572352919130473, -0.4495275978987397,
                            -0.44952759789873975, -0.08572352919130263, 0.45201621435195655, 0.883234912738086,
                            -0.7734093083464346, -0.06906595709361621, 0.42543909474828384, 0.25972131868457254,
                            -0.2597213186845724, -0.4254390947482831, 0.06906595709360897, 0.7734093083464262,
                            0.6372937644666821, -0.2427227284567702, -0.3269759103939731, 0.25377239575159893,
                            0.2537723957515991, -0.326975910393975, -0.2427227284567766, 0.6372937644666692,
                            -0.4828486810505258, 0.4033170755970771, -0.031045687085553008, -0.2915682225895845,
                            0.29156822258958437, 0.031045687085549847, -0.40331707559707947, 0.4828486810505085,
                            0.31899212911049485, -0.3867979150966231, 0.3023917023728722, -0.11342352322434288,
                            -0.11342352322434308, 0.30239170237287083, -0.38679791509661965, 0.3189921291104737,
                            -0.1550188128903624, 0.2265762384000079, -0.26852031408771393, 0.2885549685956877,
                            -0.28855496859568763, 0.268520314087716, -0.22657623839999913, 0.15501881289033861
                    }),
                    new double[8]{-0.9602898564975371, -0.7966664774136296, -0.525532409916328, -0.18343464249564984,
                                  0.18343464249564978, 0.5255324099163294, 0.7966664774136274, 0.9602898564975355},
                    new double[8]{0.10122853629037425, 0.22238103445337207, 0.31370664587788794, 0.36268378337836193,
                                  0.36268378337836193, 0.3137066458778873, 0.22238103445337357, 0.10122853629037788}
            },
            {
                    10,
                    array2d<double>(10, 10, new double[100]{
                            1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
                            -0.9739065285171686, -0.8650633666889882, -0.6794095682990249, -0.433395394129247,
                            -0.14887433898163116, 0.14887433898163116, 0.43339539412924677, 0.6794095682990237,
                            0.8650633666889889, 0.9739065285171682,
                            0.922740889432544, 0.6225019425809303, 0.19239604224440102, -0.218252648521332,
                            -0.46675464678917356, -0.46675464678917356, -0.21825264852133228, 0.19239604224439855,
                            0.622501942580932, 0.9227408894325426,
                            -0.8485012749020432, -0.32079713257316583, 0.2350801921931675, 0.44657975046225584,
                            0.21506254183332568, -0.21506254183332568, -0.4465797504622558, -0.2350801921931699,
                            0.32079713257316855, 0.8485012749020407,
                            0.7540759623195132, 0.018765776238156177, -0.4237995624971213, -0.17501532579202875,
                            0.2940357210203751, 0.2940357210203751, -0.17501532579202833, -0.42379956249712175,
                            0.0187657762381594, 0.7540759623195094,
                            -0.6431180849398782, 0.22741725203053179, 0.33021610628813863, -0.2207322953892739,
                            -0.25084390595367273, 0.25084390595367273, 0.22073229538927427, -0.33021610628813636,
                            -0.22741725203052893, 0.6431180849398727,
                            0.5198876842061506, -0.37631042528706177, -0.05814566531984909, 0.32123076511505144,
                            -0.17656536292520286, -0.17656536292520286, 0.32123076511505133, -0.058145665319845136,
                            -0.3763104252870602, 0.5198876842061435,
                            -0.3890682310047542, 0.4096310303233839, -0.20967646569634207, -0.06935219576565162,
                            0.26382601538929634, -0.26382601538929634, 0.06935219576565106, 0.20967646569634527,
                            -0.40963103032338427, 0.3890682310047457,
                            0.2555659454711607, -0.3351473744834937, 0.31798282660714994, -0.22472019031770138,
                            0.08085046072097912, 0.08085046072097912, -0.22472019031770174, 0.31798282660715005,
                            -0.33514737448349624, 0.255565945471151,
                            -0.12430099765549005, 0.18351721458258377, -0.22169756095640109, 0.24561037653348733,
                            -0.25724773603885603, 0.25724773603885603, -0.24561037653348702, 0.22169756095639767,
                            -0.18351721458258796, 0.12430099765547961
                    }),
                    new double[10]{-0.9739065285171685, -0.8650633666889883, -0.679409568299025, -0.433395394129247,
                                   -0.14887433898163116, 0.1488743389816312, 0.4333953941292468, 0.6794095682990237,
                                   0.8650633666889889, 0.9739065285171682},
                    new double[10]{0.06667134430869694, 0.14945134915057698, 0.21908636251598265, 0.26926671930999646,
                                   0.2955242247147528, 0.295524224714753, 0.2692667193099972, 0.21908636251598257,
                                   0.1494513491505774, 0.06667134430869787}
            },
            {
                    12,
                    array2d<double>(12, 12, new double[144]{
                            1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
                            -0.9815606342467325, -0.9041172563704614, -0.7699026741943014, -0.5873179542866223,
                            -0.367831498998179, -0.12523340851146902, 0.1252334085114689, 0.3678314989981788,
                            0.5873179542866254, 0.7699026741942895, 0.9041172563704775, 0.9815606342467244,
                            0.9451919180542715, 0.7261420199002758, 0.38912519159730485, 0.017413569141134365,
                            -0.29704998251712894, -0.47647489008889926, -0.4764748900888993, -0.29704998251712916,
                            0.017413569141139843, 0.3891251915972774, 0.7261420199003195, 0.9451919180542476,
                            -0.8918982081192389, -0.491451047032263, 0.013954240117642786, 0.3744997998497487,
                            0.42732823324321667, 0.1829398966009134, -0.18293989660091323, -0.42732823324321656,
                            -0.3744997998497453, -0.013954240117677779, 0.49145104703233755, 0.8918982081191925,
                            0.823147360438124, 0.23296988657039347, -0.3106448555680931, -0.3979734754307326,
                            -0.05228588615882107, 0.3172633406595553, 0.3172633406595554, -0.05228588615882065,
                            -0.39797347543073525, -0.31064485556811944, 0.2329698865704925, 0.8231473604380495,
                            -0.7408257148469124, 0.014023067232479284, 0.4193359569537251, 0.12112670153076838,
                            -0.3072442740065282, -0.21786946246448732, 0.21786946246448716, 0.30724427400652843,
                            -0.12112670153077612, -0.4193359569537269, -0.014023067232370985, 0.7408257148468059,
                            0.6471803569425079, -0.2173854834408953, -0.3330170572081713, 0.2012214375126257,
                            0.25076412855413655, -0.214364468992149, -0.21436446899214917, 0.2507641285541362,
                            0.20122143751261887, -0.3330170572081428, -0.21738548344079875, 0.6471803569423674,
                            -0.5447505160201739, 0.3529867379755224, 0.11672337941959854, -0.32330181838364047,
                            0.09205133644652115, 0.23660135504145957, -0.23660135504145943, -0.09205133644652165,
                            0.32330181838364086, -0.11672337941954888, -0.35298673797545954, 0.5447505160199992,
                            0.4362903039459244, -0.4081778290021945, 0.12289184638937803, 0.17995804703312407,
                            -0.28290495199094995, 0.13201192133636622, 0.13201192133636644, -0.28290495199094995,
                            0.1799580470331323, 0.12289184638942735, -0.4081778290021832, 0.43629030394571766,
                            -0.3246852731783611, 0.3833107352182204, -0.2824708861420405, 0.08773783137485011,
                            0.11473692244778817, -0.24153999879715496, 0.24153999879715488, -0.11473692244778762,
                            -0.08773783137484023, 0.2824708861420654, -0.3833107352182693, 0.32468527317812634,
                            0.21286546352456684, -0.2910998693974244, 0.3026000104328627, -0.2598692492393927,
                            0.17442713386048023, -0.06133786225440428, -0.06133786225440457, 0.1744271338604807,
                            -0.2598692492393896, 0.3026000104328483, -0.2910998693975303, 0.21286546352431013,
                            -0.1037177104846144, 0.15398630618683398, -0.1879740764266154, 0.21161500718203535,
                            -0.22679317280626068, 0.23424659352281785, -0.2342465935228178, 0.22679317280626043,
                            -0.21161500718204243, 0.18797407642656475, -0.15398630618698128, 0.10371771048434342
                    }),
                    new double[12]{-0.9815606342467326, -0.9041172563704614, -0.7699026741943014, -0.5873179542866224,
                                   -0.36783149899817896, -0.125233408511469, 0.12523340851146894, 0.3678314989981788,
                                   0.5873179542866254, 0.7699026741942895, 0.9041172563704775, 0.9815606342467244},
                    new double[12]{0.04717533638647901, 0.10693932599533276, 0.16007832854333748, 0.20316742672306162,
                                   0.23349253653835503, 0.24914704581340288, 0.24914704581340272, 0.23349253653835528,
                                   0.20316742672306173, 0.1600783285433453, 0.10693932599531966, 0.04717533638649818}
            },
            {
                    14,
                    array2d<double>(14, 14, new double[196]{
                            1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
                            -0.9862838086967527, -0.9284348836637202, -0.8272013150696356, -0.6872929048117413,
                            -0.5152486363581417, -0.3191123689278914, -0.10805494870734345, 0.10805494870734345,
                            0.3191123689278912, 0.515248636358144, 0.6872929048117465, 0.8272013150696276,
                            0.9284348836637257, 0.986283808696745,
                            0.959133626946059, 0.7929869998054985, 0.5263930234794018, 0.20855730550684198,
                            -0.10177826409661324, -0.347250943995844, -0.48248619208978005, -0.48248619208978005,
                            -0.3472509439958442, -0.10177826409660964, 0.20855730550685272, 0.5263930234793819,
                            0.7929869998055139, 0.9591336269460363,
                            -0.9191074052579806, -0.6081047324096206, -0.17425412539631407, 0.21929534267198222,
                            0.43090094388322575, 0.39742836487019484, 0.15892833370200005, -0.15892833370200005,
                            -0.3974283648701947, -0.4309009438832246, -0.21929534267197157, 0.17425412539628504,
                            0.6081047324096481, 0.9191074052579362,
                            0.8670260962441098, 0.39328463150352283, -0.142544094662306, -0.420178212014379,
                            -0.3122032684747594, 0.03849567075936706, 0.331811906411287, 0.331811906411287,
                            0.03849567075936747, -0.3122032684747628, -0.4201782120143763, -0.14254409466233559,
                            0.3932846315035619, 0.8670260962440378,
                            -0.8039549165912276, -0.17076672204636759, 0.3516460929251775, 0.3443776328355535,
                            -0.055168600079866355, -0.34005469233723745, -0.19167972031156347, 0.19167972031156347,
                            0.34005469233723756, 0.05516860007986095, -0.34437763283556255, -0.3516460929251963,
                            0.1707667220464148, 0.8039549165911235,
                            0.7311790679160481, -0.03706992643888643, -0.4144971237105562, -0.08378004663153875,
                            0.31228289132402065, 0.1668656481679595, -0.23853802770748195, -0.23853802770748195,
                            0.1668656481679591, 0.31228289132401865, -0.08378004663155576, -0.41449712371055486,
                            -0.03706992643883691, 0.7311790679159085,
                            -0.6501744982455993, 0.21028878560106257, 0.33535239974090436, -0.18824388371754666,
                            -0.25153310576937626, 0.19258465062701025, 0.21216515834317964, -0.21216515834317964,
                            -0.19258465062701063, 0.2515331057693803, 0.1882438837175319, -0.33535239974088005,
                            -0.21028878560101805, 0.6501744982454222,
                            0.5625744039119012, -0.333637772232176, -0.15744741564845247, 0.31589257640248947,
                            -0.0302436116336443, -0.26123771229834375, 0.16573547055231358, 0.16573547055231358,
                            -0.2612377122983435, -0.030243611633637518, 0.3158925764024872, -0.15744741564841092,
                            -0.33363777223214397, 0.5625744039116867,
                            -0.47013227244992273, 0.3981806446012169, -0.05208079335434146, -0.24277014220109658,
                            0.25301950002803086, -0.013720672910446175, -0.22241848986969306, 0.22241848986969306,
                            0.013720672910446766, -0.25301950002802803, 0.24277014220110985, 0.05208079335438715,
                            -0.3981806446012038, 0.4701322724496725,
                            0.37468234817931045, -0.40212712584124577, 0.2235571455135115, 0.03271965408416672,
                            -0.22047985901649736, 0.24343297029641012, -0.10349842831965672, -0.10349842831965672,
                            0.24343297029641028, -0.22047985901650177, 0.03271965408418851, 0.2235571455135451,
                            -0.40212712584125576, 0.3746823481790276,
                            -0.27809846156265167, 0.35077449375046715, -0.3056958296780352, 0.17776851944656158,
                            -0.01314128359308286, -0.13582956175007163, 0.22354897848433866, -0.22354897848433866,
                            0.13582956175007108, 0.013141283593074926, -0.17776851944654473, 0.3056958296780434,
                            -0.35077449375050096, 0.27809846156234114,
                            0.1822521997391779, -0.25558674754890404, 0.27974393522781477, -0.2641695136299633,
                            0.21508434196350806, -0.1400691774324125, 0.04857537693591887, 0.04857537693591887,
                            -0.14006917743241304, 0.21508434196350434, -0.2641695136299629, 0.27974393522779223,
                            -0.2555867475489588, 0.18225219973884607,
                            -0.08897140798470174, 0.13254595235832906, -0.16282798626489697, 0.1850633520213324,
                            -0.20098864956539614, 0.2113384551236013, -0.21644676833794835, 0.21644676833794835,
                            -0.21133845512360105, 0.20098864956540072, -0.18506335202135, 0.16282798626484923,
                            -0.13254595235839836, 0.08897140798435631
                    }),
                    new double[14]{-0.9862838086967527, -0.9284348836637202, -0.8272013150696356, -0.6872929048117412,
                                   -0.5152486363581417, -0.3191123689278915, -0.10805494870734346, 0.10805494870734345,
                                   0.3191123689278912, 0.515248636358144, 0.6872929048117465, 0.8272013150696276,
                                   0.9284348836637257, 0.986283808696745},
                    new double[14]{0.035119460331904884, 0.08015808715957283, 0.1215185706879927, 0.15720316715815244,
                                   0.1855383974779421, 0.20519846372129524, 0.21526385346315782, 0.21526385346315782,
                                   0.2051984637212956, 0.1855383974779424, 0.15720316715816968, 0.12151857068796204,
                                   0.0801580871596417, 0.03511946033192289}
            }
    };

    template<class D>
    D *getCoefficients(int n, std::function<D(double)> V, double a, double b) {
        LegendreData &data = legendreData[(n + 1) / 2];

        double m = (a + b) / 2;
        double h = (b - a) / 2;
        D aV[data.n];
        for (int j = 0; j < data.n; ++j)
            aV[j] = V(m + data.nodes[j] * h);

        D *coeffs = new D[n];
        double H = 1;
        for (int i = 0; i < n; ++i) {
            coeffs[i] = aV[0] * data.weights[0] * data.polynomial[i][0] * (i + .5) / H;
            for (int j = 1; j < data.n; ++j)
                coeffs[i] += aV[j] * data.weights[j] * data.polynomial[i][j] * (i + .5) / H;
            H *= h * 2;
        }

        return coeffs;
    }
};


#endif //SCHRODINGER_LEGENDRE_H
